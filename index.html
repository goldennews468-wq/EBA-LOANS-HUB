<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EBA LOANS HUB â€” Realtime Loans + Repayments + Paystack</title>

  <style>
    :root{
      --bg:#041028; --panel:#07233a; --muted:#9fb0c9; --accent:#1f8cff;
      --accent-2:#0d6efd; --success:#15b37b; --danger:#ff6b6b; --text:#e6f0ff;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{margin:0;background:linear-gradient(180deg,#031322 0%,var(--bg) 100%);color:var(--text);min-height:100vh;padding:30px}
    .form-control{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:var(--text)}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#042033;cursor:pointer;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)}
    .btn-success{background:var(--success);color:#042033}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;padding:16px}
    .modal-card{width:100%;max-width:920px;background:linear-gradient(180deg,var(--panel),#071a2b);padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .notification{position:fixed;top:22px;right:20px;background:linear-gradient(180deg,#042338,#072a40);padding:12px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.7);transform:translateX(120%);transition:transform .25s;z-index:10000;color:var(--text)}
    .notification.show{transform:translateX(0)}
    .notification.success{border-left:6px solid var(--success)}
    .notification.error{border-left:6px solid var(--danger)}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);font-size:14px;text-align:left}
    th{background:rgba(255,255,255,0.05)}
    tr:hover{background:rgba(255,255,255,0.08);cursor:pointer}
  </style>
</head>
<body>

<h2 style="color:var(--accent)">âž• Add Loan Client</h2>
<form id="addLoanForm" style="margin-top:12px">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <input id="clientName" class="form-control" placeholder="Client Full Name" required style="flex:1" />
    <input id="clientGhanaCard" class="form-control" placeholder="GHA-XXXXXXXXX-X" required style="flex:1" />
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
    <input id="clientPhone" class="form-control" placeholder="+233XXXXXXXXX" required style="flex:1" />
    <input id="clientAddress" class="form-control" placeholder="Address" style="flex:1" />
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
    <input id="clientAmount" class="form-control" type="number" placeholder="Loan Amount (â‚µ)" required style="flex:1" />
    <input id="clientPurpose" class="form-control" placeholder="Purpose" required style="flex:1" />
  </div>
  <div style="margin-top:8px">
    <label>Passport Picture</label>
    <input id="clientPhoto" type="file" accept="image/*" capture="environment" class="form-control" />
    <img id="photoPreview" style="width:100px;height:100px;border-radius:8px;margin-top:8px;display:none;border:2px solid var(--accent)" />
  </div>
  <div style="margin-top:10px">
    <button class="btn" type="submit">Submit Application</button>
  </div>
</form>

<h2 style="margin-top:40px;color:var(--accent)">ðŸ“‹ All Loan Records (Realtime)</h2>
<table id="loansTable">
  <thead><tr><th>Client</th><th>GhanaCard</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead>
  <tbody id="loansBody"></tbody>
</table>

<!-- Loan Details Modal -->
<div id="loanDetailsModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Loan Details</h3>
      <button onclick="closeModal('loanDetailsModal')" class="btn-ghost">Ã—</button>
    </div>
    <div id="loanDetailsContent" style="margin-top:12px"></div>
    <h4 style="margin-top:20px">ðŸ’° Repayment History (Realtime)</h4>
    <table>
      <thead><tr><th>Amount</th><th>Type</th><th>Ref</th><th>Date</th></tr></thead>
      <tbody id="repaymentsList"><tr><td colspan="4" style="text-align:center;color:var(--muted)">No repayments yet</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Repayment Modal -->
<div id="repaymentModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Record Repayment</h3>
      <button onclick="closeModal('repaymentModal')" class="btn-ghost">Ã—</button>
    </div>
    <form id="repaymentForm" style="margin-top:12px">
      <input type="hidden" id="repLoanId" />
      <div style="display:flex;gap:8px">
        <input id="repAmount" class="form-control" placeholder="Amount" type="number" required />
        <select id="repType" class="form-control">
          <option value="principal">Principal</option>
          <option value="interest">Interest</option>
          <option value="penalty">Penalty</option>
        </select>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn btn-success" type="submit">Pay with Paystack</button>
        <button type="button" onclick="closeModal('repaymentModal')" class="btn-ghost">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div id="notification" class="notification"><div id="notificationMessage">Done</div></div>

<!-- Paystack SDK -->
<script src="https://js.paystack.co/v1/inline.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script>
/* --- Firebase Config --- */
const firebaseConfig = {
  apiKey: "AIzaSyB0cCHQFHwZX2hQtErVmpx9XQIXU474dJA",
  authDomain: "eba-loans-hub-b1512.firebaseapp.com",
  databaseURL: "https://eba-loans-hub-b1512-default-rtdb.firebaseio.com",
  projectId: "eba-loans-hub-b1512",
  storageBucket: "eba-loans-hub-b1512.firebasestorage.app",
  messagingSenderId: "406151539685",
  appId: "1:406151539685:web:28c631ba2721f1b28fdd0c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* --- Helpers --- */
function showNotification(msg, type='success'){
  const n=document.getElementById('notification'); 
  const m=document.getElementById('notificationMessage'); 
  n.className = `notification ${type} show`; 
  m.textContent = msg; 
  setTimeout(()=> n.className='notification', 3000);
}
function closeModal(id){ document.getElementById(id).style.display='none'; }
function money(n){ return 'â‚µ' + (Number(n)||0).toLocaleString(); }

/* --- Image Preview --- */
clientPhoto.addEventListener('change', e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{photoPreview.src=reader.result;photoPreview.style.display='block';};
  reader.readAsDataURL(file);
});

/* --- Add Loan --- */
addLoanForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const clientName = clientName.value.trim();
  const ghanaCard = clientGhanaCard.value.trim().toUpperCase();
  const phone = clientPhone.value.trim();
  const address = clientAddress.value.trim();
  const amount = Number(clientAmount.value);
  const purpose = clientPurpose.value.trim();
  const file = clientPhoto.files[0];
  let photoUrl=null;
  try{
    if(file){
      const ref=storage.ref('client_photos/'+ghanaCard+'_'+Date.now());
      const snap=await ref.put(file);
      photoUrl=await snap.ref.getDownloadURL();
    }
  }catch(e){showNotification('Photo upload failed','error');}

  const loan={id:Date.now().toString(36),clientName,ghanaCard,phone,address,amount,purpose,photoUrl,status:'pending',createdAt:new Date().toISOString()};
  const ref=db.ref('eba_v3_loans');
  ref.once('value',s=>{const arr=s.val()||[];arr.push(loan);ref.set(arr);});
  showNotification('Loan submitted','success');
  e.target.reset(); photoPreview.style.display='none';
});

/* --- Realtime Loans Table --- */
const loansRef=db.ref('eba_v3_loans');
loansRef.on('value',snap=>{
  const body=loansBody;const loans=snap.val()||[];
  body.innerHTML='';
  loans.slice().reverse().forEach(l=>{
    body.innerHTML+=`<tr onclick="openLoanDetails('${l.id}')">
      <td>${l.clientName}</td><td>${l.ghanaCard}</td><td>${money(l.amount)}</td><td>${l.status}</td><td>${new Date(l.createdAt).toLocaleDateString()}</td></tr>`;
  });
});

/* --- Loan Details Modal + Realtime Repayments --- */
async function openLoanDetails(id){
  const s=await loansRef.once('value');const loans=s.val()||[];
  const l=loans.find(x=>x.id===id);if(!l)return showNotification('Not found','error');
  document.getElementById('loanDetailsContent').innerHTML=`
    <div style="display:flex;gap:20px;align-items:flex-start">
      <div style="flex:1">
        <h4>Client Info</h4>
        <div><strong>${l.clientName}</strong></div>
        <div>GhanaCard: ${l.ghanaCard}</div>
        <div>Phone: ${l.phone}</div>
        <div>Address: ${l.address||'-'}</div>
        <div>Status: ${l.status}</div>
      </div>
      <div>${l.photoUrl?`<img src="${l.photoUrl}" style="width:120px;height:120px;border-radius:8px;border:2px solid var(--accent)">`:'<div>No Photo</div>'}</div>
    </div>
    <hr/><h4>Loan Info</h4>
    <div>Amount: ${money(l.amount)}</div><div>Purpose: ${l.purpose}</div>
    <div>Date: ${new Date(l.createdAt).toLocaleString()}</div>
    <div style="margin-top:12px">
      <button class="btn btn-success" onclick="openRepaymentModal('${l.id}')">Record Repayment</button>
    </div>`;
  document.getElementById('loanDetailsModal').style.display='flex';
  watchRepayments(l.id);
}

/* --- Realtime Repayment Listener --- */
function watchRepayments(loanId){
  const list=document.getElementById('repaymentsList');
  const ref=db.ref('eba_v3_reps');
  ref.off(); // stop previous
  ref.on('value',snap=>{
    const reps=snap.val()||[];
    const filtered=reps.filter(r=>r.loanId===loanId);
    if(filtered.length===0){
      list.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--muted)">No repayments yet</td></tr>';
    }else{
      list.innerHTML='';
      filtered.forEach(r=>{
        list.innerHTML+=`<tr><td>${money(r.amount)}</td><td>${r.type}</td><td>${r.paystackRef}</td><td>${new Date(r.date).toLocaleString()}</td></tr>`;
      });
    }
  });
}

/* --- Paystack Repayment --- */
repaymentForm.addEventListener('submit', e=>{
  e.preventDefault();
  const loanId=repLoanId.value;
  const amount=Number(repAmount.value);
  const type=repType.value;
  if(!amount||amount<=0)return showNotification('Invalid amount','error');
  const handler=PaystackPop.setup({
    key:'pk_live_6c49dba40c4aa95938a74589cab5ed687c75fd3a',
    email:'client@ebaloanshub.com',
    amount:amount*100,currency:'GHS',ref:'EBA-'+Date.now(),
    callback:function(r){
      const rep={id:Date.now().toString(36),loanId,amount,type,date:new Date().toISOString(),paystackRef:r.reference};
      const reps=db.ref('eba_v3_reps');
      reps.once('value',s=>{const arr=s.val()||[];arr.unshift(rep);reps.set(arr);});
      showNotification('Payment successful! Ref: '+r.reference,'success');
      closeModal('repaymentModal');
    },
    onClose:function(){showNotification('Payment cancelled','error');}
  });
  handler.openIframe();
});
function openRepaymentModal(id){repLoanId.value=id;repaymentModal.style.display='flex';}
</script>
</body>
</html>
